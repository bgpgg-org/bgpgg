name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Validate version matches tag
        run: |
          TAG_VERSION="${{ github.ref_name }}"
          CARGO_VERSION="v$(grep '^version' Cargo.toml | head -n1 | sed 's/.*"\(.*\)".*/\1/')"

          echo "Git tag: $TAG_VERSION"
          echo "Cargo.toml version: $CARGO_VERSION"

          if [ "$TAG_VERSION" != "$CARGO_VERSION" ]; then
            echo "ERROR: Version mismatch!"
            echo "Git tag is $TAG_VERSION but Cargo.toml has version $CARGO_VERSION"
            echo "Please update Cargo.toml [workspace.package] version to match the tag"
            exit 1
          fi

          echo "Versions match"

      - name: Setup dependencies
        run: make setup

      - name: Build release
        run: make build version=${{ github.ref_name }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Prepare Docker build context
        run: |
          VERSION="${{ github.ref_name }}"
          mkdir -p /tmp/docker-build
          cp docker/Dockerfile /tmp/docker-build/
          cp release/$VERSION/bgpgg-$VERSION-x86_64-linux.tar.gz /tmp/docker-build/
          cp release/$VERSION/bgpgg-$VERSION-aarch64-linux.tar.gz /tmp/docker-build/
          cp release/$VERSION/bgpgg-$VERSION-armv7-linux.tar.gz /tmp/docker-build/
          cp release/$VERSION/bgpgg-$VERSION-i686-linux.tar.gz /tmp/docker-build/

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: /tmp/docker-build
          push: true
          platforms: linux/amd64,linux/arm64,linux/arm/v7,linux/386
          tags: |
            bgpgg/bgpgg:${{ github.ref_name }}
            bgpgg/bgpgg:latest
          build-args: |
            VERSION=${{ github.ref_name }}

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ github.ref_name }}"

          # Determine if prerelease (version not matching vX.Y.Z)
          FLAGS=""
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            FLAGS="--prerelease"
          fi

          gh release create "$VERSION" \
            release/$VERSION/*.tar.gz \
            $FLAGS \
            --title="$VERSION" \
            --generate-notes \
            --draft
