syntax = "proto3";

package bgp;

// ============================================================================
// BGP Service
// ============================================================================
service BgpService {
    rpc AddPeer(AddPeerRequest) returns (AddPeerResponse);
    rpc RemovePeer(RemovePeerRequest) returns (RemovePeerResponse);
    rpc DisablePeer(DisablePeerRequest) returns (DisablePeerResponse);
    rpc EnablePeer(EnablePeerRequest) returns (EnablePeerResponse);
    rpc GetPeers(GetPeersRequest) returns (GetPeersResponse);
    rpc GetPeer(GetPeerRequest) returns (GetPeerResponse);
    rpc AddRoute(AddRouteRequest) returns (AddRouteResponse);
    rpc RemoveRoute(RemoveRouteRequest) returns (RemoveRouteResponse);
    rpc GetRoutes(GetRoutesRequest) returns (GetRoutesResponse);
    rpc GetServerInfo(GetServerInfoRequest) returns (GetServerInfoResponse);
}

message GetServerInfoRequest {}

message GetServerInfoResponse {
    string listen_addr = 1;
    uint32 listen_port = 2;
}

// Action when max prefix limit is reached
enum MaxPrefixAction {
    TERMINATE = 0;  // Send CEASE and close session
    DISCARD = 1;    // Drop new prefixes, keep session
}

// Max prefix limit configuration
message MaxPrefixSetting {
    uint32 limit = 1;
    MaxPrefixAction action = 2;
}

// Per-peer session configuration (RFC 4271 Section 8.1 optional attributes)
message SessionConfig {
    optional uint64 idle_hold_time_secs = 1;      // Auto-reconnect delay. Unset disables (default: 30s)
    optional bool damp_peer_oscillations = 2;     // Exponential backoff on failures (default: true)
    optional bool allow_automatic_stop = 3;       // Auto-stop on max prefix exceeded (default: true)
    optional bool passive_mode = 4;               // Wait for remote to connect (default: false)
    optional uint64 delay_open_time_secs = 5;     // Delay before sending OPEN. Unset disables
    optional MaxPrefixSetting max_prefix = 6;
    optional bool send_notification_without_open = 7;  // Allow NOTIFICATION before OPEN (default: false)
    optional bool collision_detect_established_state = 8;  // Process collisions in Established (default: false)
    optional uint64 min_route_advertisement_interval_secs = 9;  // MRAI timer (RFC 4271 9.2.1.1, default: 0)
}

// Add peer request/response
message AddPeerRequest {
    string address = 1;              // IP:PORT format (e.g., "192.168.1.1:179")
    optional SessionConfig config = 2;  // Omit for all defaults
}

message AddPeerResponse {
    bool success = 1;
    string message = 2;
}

// Remove peer request/response
message RemovePeerRequest {
    string address = 1;
}

message RemovePeerResponse {
    bool success = 1;
    string message = 2;
}

// Disable peer request/response (RFC 4486 Administrative Shutdown)
message DisablePeerRequest {
    string address = 1;
}

message DisablePeerResponse {}

// Enable peer request/response (RFC 4486 undo Administrative Shutdown)
message EnablePeerRequest {
    string address = 1;
}

message EnablePeerResponse {}

// Get peers request/response
message GetPeersRequest {}

message GetPeersResponse {
    repeated Peer peers = 1;
}

// Get peer request/response
message GetPeerRequest {
    string address = 1;  // Peer IP address
}

message GetPeerResponse {
    Peer peer = 1;
    PeerStatistics statistics = 2;
}

// Peer statistics
message PeerStatistics {
    uint64 open_sent = 1;
    uint64 keepalive_sent = 2;
    uint64 update_sent = 3;
    uint64 notification_sent = 4;
    uint64 open_received = 5;
    uint64 keepalive_received = 6;
    uint64 update_received = 7;
    uint64 notification_received = 8;
}

// BGP FSM states
enum BgpState {
    IDLE = 0;
    CONNECT = 1;
    ACTIVE = 2;
    OPEN_SENT = 3;
    OPEN_CONFIRM = 4;
    ESTABLISHED = 5;
}

// Administrative state of a peer
enum AdminState {
    UP = 0;
    DOWN = 1;
    PREFIX_LIMIT_EXCEEDED = 2;
}

// Peer information
message Peer {
    string address = 1;
    uint32 asn = 2;
    BgpState state = 3;
    AdminState admin_state = 4;
    bool configured = 5;  // true if explicitly configured, false if accepted via accept_unconfigured_peers
}

// Add route request/response
message AddRouteRequest {
    string prefix = 1;      // CIDR format (e.g., "10.0.0.0/24")
    string next_hop = 2;    // IPv4 address (e.g., "192.168.1.1")
    Origin origin = 3;      // Route origin
    repeated AsPathSegment as_path = 4; // Optional AS_PATH (empty = locally originated)
    optional uint32 local_pref = 5;     // Optional LOCAL_PREF (defaults to 100)
    optional uint32 med = 6;            // Optional MULTI_EXIT_DISC
    bool atomic_aggregate = 7;          // ATOMIC_AGGREGATE attribute
}

message AddRouteResponse {
    bool success = 1;
    string message = 2;
}

// Remove route request/response
message RemoveRouteRequest {
    string prefix = 1;      // CIDR format (e.g., "10.0.0.0/24")
}

message RemoveRouteResponse {
    bool success = 1;
    string message = 2;
}

// BGP Origin attribute
enum Origin {
    IGP = 0;
    EGP = 1;
    INCOMPLETE = 2;
}

// AS_PATH segment type
enum AsPathSegmentType {
    AS_SET = 0;
    AS_SEQUENCE = 1;
}

// AS_PATH segment
message AsPathSegment {
    AsPathSegmentType segment_type = 1;
    repeated uint32 asns = 2;
}

// Get routes request/response
message GetRoutesRequest {}

message GetRoutesResponse {
    repeated Route routes = 1;
}

// Route information
message Route {
    string prefix = 1;      // CIDR format
    repeated Path paths = 2; // Multiple paths to same prefix
}

// Path information
message Path {
    Origin origin = 1;
    repeated AsPathSegment as_path = 2;
    string next_hop = 3;
    string peer_address = 4;
    optional uint32 local_pref = 5;
    optional uint32 med = 6;
    bool atomic_aggregate = 7;
    repeated UnknownAttribute unknown_attributes = 8;
}

// Unknown attribute
message UnknownAttribute {
    uint32 attr_type = 1;
    uint32 flags = 2;
    bytes value = 3;
}
